# Task 07: Score Config Updates

**Task ID:** openapi-update-07
**Priority:** Medium
**Dependencies:** None
**Approach:** Implementation

## Objective

Add support for updating score configurations via PATCH endpoint and add sessionId parameter to the scores list endpoint.

## What Needs to Be Done

### Files to Create

Create the following file in `src/Langfuse/Models/ScoreConfig/`:

1. **UpdateScoreConfigRequest.cs**
   ```csharp
   /// <summary>
   /// Request to update a score configuration (partial update)
   /// </summary>
   public record UpdateScoreConfigRequest
   {
       /// <summary>
       /// The status of the score config showing if it is archived or not
       /// </summary>
       [JsonPropertyName("isArchived")]
       public bool? IsArchived { get; init; }

       /// <summary>
       /// The name of the score config
       /// </summary>
       [JsonPropertyName("name")]
       public string? Name { get; init; }

       /// <summary>
       /// Configure custom categories for categorical scores.
       /// Pass a list of objects with label and value properties.
       /// Categories are autogenerated for boolean configs and cannot be passed.
       /// </summary>
       [JsonPropertyName("categories")]
       public ConfigCategory[]? Categories { get; init; }

       /// <summary>
       /// Configure a minimum value for numerical scores.
       /// If not set, the minimum value defaults to -∞
       /// </summary>
       [JsonPropertyName("minValue")]
       public double? MinValue { get; init; }

       /// <summary>
       /// Configure a maximum value for numerical scores.
       /// If not set, the maximum value defaults to +∞
       /// </summary>
       [JsonPropertyName("maxValue")]
       public double? MaxValue { get; init; }

       /// <summary>
       /// Description is shown across the Langfuse UI and can be used to e.g.
       /// explain the config categories in detail, why a numeric range was set,
       /// or provide additional context on config name or usage
       /// </summary>
       [JsonPropertyName("description")]
       public string? Description { get; init; }
   }
   ```

### Files to Modify

**1. src/Langfuse/Client/LangfuseClient.Score.cs**

Add new method for updating score config:

```csharp
/// <summary>
/// Update a score config (partial update)
/// </summary>
/// <param name="configId">The unique langfuse identifier of a score config</param>
/// <param name="request">Score config update details</param>
/// <param name="cancellationToken">Cancellation token</param>
/// <returns>Updated score config</returns>
public async Task<ScoreConfig> UpdateScoreConfigAsync(
    string configId,
    UpdateScoreConfigRequest request,
    CancellationToken cancellationToken = default)
{
    ArgumentException.ThrowIfNullOrWhiteSpace(configId);
    ArgumentNullException.ThrowIfNull(request);

    var httpRequest = new HttpRequestMessage(new HttpMethod("PATCH"),
        $"score-configs/{Uri.EscapeDataString(configId)}")
    {
        Content = JsonContent.Create(request, options: _jsonOptions)
    };

    var response = await _httpClient.SendAsync(httpRequest, cancellationToken);

    response.EnsureSuccessStatusCode();

    var result = await response.Content.ReadFromJsonAsync<ScoreConfig>(
        _jsonOptions,
        cancellationToken);

    return result ?? throw new LangfuseApiException("Failed to deserialize response");
}
```

**2. src/Langfuse/Models/Score/GetScoresRequest.cs**

Add sessionId parameter to existing request model:

```csharp
// Add this property to the existing GetScoresRequest record:

/// <summary>
/// Retrieve only scores with a specific sessionId
/// </summary>
[JsonPropertyName("sessionId")]
public string? SessionId { get; init; }
```

**3. src/Langfuse/Client/LangfuseClient.Score.cs - GetScoresAsync method**

Update the GetScoresAsync method to include sessionId in query string:

```csharp
// In the existing GetScoresAsync method, add:
if (!string.IsNullOrWhiteSpace(request.SessionId))
    queryParams.Add($"sessionId={Uri.EscapeDataString(request.SessionId)}");
```

### Key Implementation Points

1. **PATCH Method:** Use `new HttpMethod("PATCH")` to create PATCH request
2. **Partial Update:** All fields in UpdateScoreConfigRequest are nullable (partial update)
3. **ConfigId:** URL encode the configId path parameter
4. **SessionId:** Add to existing GetScoresAsync method's query string builder
5. **Existing Types:** Use existing `ConfigCategory` type from the models

### Testing Requirements

Update existing tests or create new: `tests/Langfuse.Tests/Client/LangfuseClientScoreTests.cs`

Tests to write:

1. **UpdateScoreConfigAsync:**
   - Test successful PATCH request
   - Test partial update with only some fields
   - Test all fields update
   - Test request serialization
   - Test response deserialization
   - Test configId is URL encoded
   - Test throws on null/empty configId
   - Test throws on null request

2. **GetScoresAsync with sessionId:**
   - Test sessionId parameter in query string
   - Test sessionId is URL encoded
   - Test works with other parameters
   - Test with null sessionId (not included in query)

3. **Model Tests:**
   - Test UpdateScoreConfigRequest serialization
   - Test all nullable fields serialize correctly
   - Test null fields are omitted or sent as null

### Edge Cases

1. **Nullable Fields:** Test that only provided fields are updated
2. **Validation:** What happens if minValue > maxValue?
3. **Boolean Categories:** Test that categories cannot be set for boolean configs
4. **Empty Update:** What if all fields are null?

## Acceptance Criteria

- [x] UpdateScoreConfigRequest.cs created in `src/Langfuse/Models/Score/` (Note: placed in Score folder not ScoreConfig folder following project conventions)
- [x] All properties nullable (partial update support)
- [x] Proper JSON serialization attributes
- [x] XML documentation on all properties
- [x] UpdateScoreConfigAsync method added to LangfuseClient.ScoreConfig.cs
- [x] PATCH HTTP method used correctly
- [x] Path parameters properly URL encoded
- [x] SessionId property added to ScoreListRequest (GetScoresRequest doesn't exist, SessionId added to ScoreListRequest)
- [x] GetScoreListAsync updated to include sessionId in query string via QueryStringHelper
- [x] SessionId properly URL encoded in query string
- [x] Tests added for UpdateScoreConfigAsync
- [x] Tests added for sessionId parameter
- [x] Tests verify partial update behavior
- [x] All tests pass
- [x] Code builds without warnings
